<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Assistant</title>
    <style>
        body { font-family: Arial, sans-serif; text-align: center; }
        #chatbox { width: 80%; max-width: 500px; margin: auto; padding: 10px; border: 1px solid #ccc; height: 400px; overflow-y: auto; }
        #userInput { width: 80%; padding: 10px; }
        button { padding: 10px; margin-top: 5px; }
    </style>
</head>
<body>
    <h1>Demenz Trainer</h1>
    <div id="chatbox"></div>
    <input type="text" id="userInput" placeholder="Type a message">
    <button onclick="sendMessage()">Send</button>
    <button onclick="startVoiceInput()">üé§ Sprechen</button>
    <button onclick="stopVoiceInput()">üõë Stop</button>

    <script>
async function sendMessage() {
    let userInput = document.getElementById("userInput").value;
    let chatbox = document.getElementById("chatbox");

    chatbox.innerHTML += `<p><strong>You:</strong> ${userInput}</p>`;
    document.getElementById("userInput").value = "";

    // Check if thread ID exists, otherwise create one
    let threadId = sessionStorage.getItem("threadId");
    if (!threadId) {
        let threadResponse = await fetch("https://demenzki.onrender.com/new-thread", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({})
        });
        let threadData = await threadResponse.json();
        threadId = threadData.threadId;
        sessionStorage.setItem("threadId", threadId);
    }

    let response = await fetch("https://demenzki.onrender.com/chat", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ threadId: threadId, message: userInput })
    });

    let data = await response.json();
    chatbox.innerHTML += `<p><strong>AI:</strong> ${data.reply}</p>`;

    playAudio(data.reply);
}


async function playAudio(text) {
    let response = await fetch("https://demenzki.onrender.com/text-to-speech", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ text: text })
    });

    if (!response.ok) {
        console.error("‚ùå Failed to fetch TTS audio.");
        return;
    }

    // ‚úÖ Create an AudioContext for real-time playback
    const audioContext = new AudioContext();
    const reader = response.body.getReader();
    let audioChunks = [];

    const audioStream = new ReadableStream({
        start(controller) {
            function push() {
                reader.read().then(({ done, value }) => {
                    if (done) {
                        const audioBlob = new Blob(audioChunks, { type: "audio/mpeg" });
                        const audioUrl = URL.createObjectURL(audioBlob);
                        const audio = new Audio(audioUrl);
                        audio.play().catch(error => console.error("‚ùå Audio playback error:", error));
                        return;
                    }
                    audioChunks.push(value);
                    controller.enqueue(value);
                    push();
                });
            }
            push();
        }
    });

    const audioBlob = new Blob(audioChunks, { type: "audio/mpeg" });
    const audioUrl = URL.createObjectURL(audioBlob);
    const audio = new Audio(audioUrl);
    audio.play().catch(error => console.error("‚ùå Audio playback error:", error));
}		
		

        let recognition;
let fullTranscript = ""; // ‚úÖ Ensure this persists between function calls

function startVoiceInput() {
    recognition = new (window.SpeechRecognition || window.webkitSpeechRecognition)();
    recognition.lang = "de-DE"; // ‚úÖ German speech recognition
    recognition.continuous = false; // ‚úÖ Only capture one sentence per activation
    recognition.interimResults = false; // ‚úÖ Only return final text

    recognition.onresult = function(event) {
        for (let i = event.resultIndex; i < event.results.length; i++) {
            fullTranscript += event.results[i][0].transcript + " ";
        }
        document.getElementById("userInput").value = fullTranscript.trim();
    };

    recognition.onend = function() {
        if (fullTranscript.length > 0) {
            sendMessage();
            fullTranscript = ""; // ‚úÖ Reset for next input
        }
    };

    recognition.onerror = function(event) {
        console.error("‚ùå Voice recognition error:", event.error);
    };

    recognition.start();
}

function stopVoiceInput() {
    if (recognition) {
        recognition.stop();
        if (fullTranscript.length > 0) {
            sendMessage();
            fullTranscript = ""; // ‚úÖ Reset after sending
        }
    }
}
		// Reset thread ID when page refreshes
window.onload = function() {
    sessionStorage.removeItem("threadId"); // Clears the thread on refresh
};
    </script>
</body>
</html>